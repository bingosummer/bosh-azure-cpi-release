---
groups:
  - name: bosh-azure-cpi-release
    jobs:
      - build-candidate
      - promote-candidate-major
      - promote-candidate-minor
      - promote-candidate-patch

jobs:
  - name: build-candidate
    serial: true
    plan:
      - aggregate:
        - {trigger: false, get: bosh-cpi-src, resource: bosh-cpi-src-in}
        - {trigger: false, get: version-semver, params: {bump: patch}}
        - {trigger: false, get: bosh-cli}
      - put: version-semver
        params: {file: version-semver/number}
      - task: build
        file: bosh-cpi-src/ci/tasks/build-candidate.yml
      - put: bosh-cpi-dev-artifacts
        params: {file: candidate/*.tgz}

  - name: promote-candidate-major
    plan:
      - aggregate:
        - {trigger: false, get: bosh-cpi-release, resource: bosh-cpi-dev-artifacts, passed: [build-candidate]}
        - {trigger: false, get: bosh-cpi-src, resource: bosh-cpi-src-out}
        - {trigger: false, get: release-version-semver, params: {bump: major}}
        - {trigger: false, get: bosh-cli}
      - task: promote
        file: bosh-cpi-src/ci/tasks/promote-candidate.yml
        params:
          S3_ACCESS_KEY_ID:     {{s3_access_key__promote}}
          S3_SECRET_ACCESS_KEY: {{s3_secret_key__promote}}
      - put: bosh-cpi-src
        resource: bosh-cpi-src-out
        params: {repository: promoted/repo, rebase: true, tag_prefix: "v", tag: promoted/semver_version}
      - put: release-version-semver
        params: {file: release-version-semver/number}

  - name: promote-candidate-minor
    plan:
      - aggregate:
        - {trigger: false, get: bosh-cpi-release, resource: bosh-cpi-dev-artifacts, passed: [build-candidate]}
        - {trigger: false, get: bosh-cpi-src, resource: bosh-cpi-src-out}
        - {trigger: false, get: release-version-semver, params: {bump: minor}}
        - {trigger: false, get: bosh-cli}
      - task: promote
        file: bosh-cpi-src/ci/tasks/promote-candidate.yml
        params:
          S3_ACCESS_KEY_ID:     {{s3_access_key__promote}}
          S3_SECRET_ACCESS_KEY: {{s3_secret_key__promote}}
      - put: bosh-cpi-src
        resource: bosh-cpi-src-out
        params: {repository: promoted/repo, rebase: true, tag_prefix: "v", tag: promoted/semver_version}
      - put: release-version-semver
        params: {file: release-version-semver/number}

  - name: promote-candidate-patch
    plan:
      - aggregate:
        - {trigger: false, get: bosh-cpi-release, resource: bosh-cpi-dev-artifacts, passed: [build-candidate]}
        - {trigger: false, get: bosh-cpi-src, resource: bosh-cpi-src-out}
        - {trigger: false, get: release-version-semver, params: {bump: patch}}
        - {trigger: false, get: bosh-cli}
      - task: promote
        file: bosh-cpi-src/ci/tasks/promote-candidate.yml
        params:
          S3_ACCESS_KEY_ID:     {{s3_access_key__promote}}
          S3_SECRET_ACCESS_KEY: {{s3_secret_key__promote}}
      - put: bosh-cpi-src
        resource: bosh-cpi-src-out
        params: {repository: promoted/repo, rebase: true, tag_prefix: "v", tag: promoted/semver_version}
      - put: release-version-semver
        params: {file: release-version-semver/number}

resources:
  - name: bosh-cpi-dev-artifacts
    type: s3
    source:
      regexp: bosh-azure-cpi-(\d+\.\d+\.\d+)\.tgz
      bucket: {{s3_azure_cpi_pipeline_bucket}}
      region_name: {{s3_region__primary}}
      access_key_id: {{s3_access_key__primary}}
      secret_access_key: {{s3_secret_key__primary}}
  - name: bosh-cpi-src-in
    type: git
    source:
      uri: git@github.com:bingosummer/bosh-azure-cpi-release.git
      branch: v34.x
      private_key: {{github_deployment_key__bosh-azure-cpi-release}}
      ignore_paths:
        - .final_builds/**/*.yml
        - releases/**/*.yml
  - name: bosh-cpi-src-out
    type: git
    source:
      uri: git@github.com:bingosummer/bosh-azure-cpi-release.git
      branch: v34.x
      private_key: {{github_deployment_key__bosh-azure-cpi-release}}
  - name: version-semver
    type: semver
    source:
      key:               current-version # dev-release version
      bucket:            {{s3_azure_cpi_pipeline_bucket}}
      access_key_id:     {{s3_access_key__primary}}
      secret_access_key: {{s3_secret_key__primary}}
  - name: release-version-semver
    type: semver
    source:
      key:               release-current-version-v34
      bucket:            {{s3_azure_cpi_pipeline_bucket}}
      access_key_id:     {{s3_access_key__primary}}
      secret_access_key: {{s3_secret_key__primary}}
  - name: bosh-cli
    type: s3
    source:
      regexp: bosh-cli-([0-9.]+)-linux-amd64
      bucket: bosh-cli-artifacts
      region_name: us-east-1
